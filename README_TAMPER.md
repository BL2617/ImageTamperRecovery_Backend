# 图像篡改定位与恢复系统

## 功能概述

本系统实现了基于LSB（最低有效位）水印的图像篡改定位与恢复功能。

### 核心功能

1. **水印嵌入**：使用LSB方法在图像中嵌入水印，配合用户密钥进行加密
2. **篡改检测**：检测图像是否被篡改，并可视化显示篡改位置
3. **图像恢复**：当检测到篡改时，可以恢复原始图像

## 技术方案

### 水印嵌入算法

- **方法**：LSB（最低有效位）嵌入
- **加密**：使用用户密钥生成伪随机序列
- **位置**：在RGB图像的R通道的LSB中嵌入水印位

### 篡改检测算法

1. 使用相同的密钥生成原始水印序列
2. 从图像中提取LSB位
3. 比较原始水印和提取的水印
4. 标记不一致的位置（红色标记）
5. 计算篡改比例

### 恢复机制

1. 上传原图时，使用密钥加密备份原图
2. 检测到篡改时，使用密钥解密备份
3. 返回恢复的原图

## 后端服务

### 服务端口

- **主服务**：8000端口 - 图片查询和下载
- **上传服务**：8001端口 - 图片上传（包含水印嵌入和备份）
- **检测服务**：8002端口 - 篡改检测和恢复

### API接口

#### 上传接口（8001端口）

```
POST /api/upload
Content-Type: multipart/form-data

file: [图片文件]
category: [可选，图片分类]
key: [可选，用户密钥]
```

**功能**：
- 如果提供了密钥，会：
  1. 先加密备份原图
  2. 然后在图像中嵌入水印
  3. 保存密钥哈希值

#### 检测接口（8002端口）

```
POST /api/detect/{image_id}
Content-Type: application/x-www-form-urlencoded

key: [用户密钥]
```

**返回**：
```json
{
  "code": 200,
  "message": "检测完成",
  "data": {
    "isTampered": true/false,
    "tamperRatio": 0.05,
    "visualizationUrl": "http://..."
  }
}
```

#### 恢复接口（8002端口）

```
POST /api/recover/{image_id}
Content-Type: application/x-www-form-urlencoded

key: [用户密钥]
```

**返回**：恢复的原图文件

## 启动服务

### 1. 主服务

```bash
cd ImageTamperRecovery_Backend
python main.py
```

### 2. 上传服务

```bash
python upload_image.py
```

### 3. 检测服务

```bash
python tamper_detection.py
```

## 使用流程

### 1. 上传原图（带密钥）

1. 用户选择图片
2. 输入密钥（可选）
3. 系统自动：
   - 加密备份原图
   - 嵌入水印
   - 保存到服务器

### 2. 检测篡改

1. 在图片详情页点击"检测"按钮
2. 输入密钥
3. 系统显示：
   - 是否被篡改
   - 篡改比例
   - 篡改位置可视化（红色标记）

### 3. 恢复原图

1. 在图片详情页点击"恢复"按钮
2. 输入密钥
3. 系统返回恢复的原图

## 注意事项

1. **密钥安全**：密钥不会存储在服务器，只存储密钥的哈希值
2. **备份加密**：原图备份使用Fernet对称加密
3. **水印不可见**：LSB嵌入对图像质量影响极小
4. **检测阈值**：默认篡改比例超过1%才判定为被篡改

## 改进建议

1. **更复杂的水印算法**：可以使用DCT、DWT等频域方法
2. **多通道嵌入**：在RGB三个通道都嵌入水印
3. **鲁棒性增强**：抵抗JPEG压缩、缩放等操作
4. **密钥管理**：实现更安全的密钥管理系统



